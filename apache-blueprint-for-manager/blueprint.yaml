#this cloudify blueprint is for apache on centos
tosca_definitions_version: cloudify_dsl_1_2

imports:
  - http://www.getcloudify.org/spec/cloudify/3.3.1/types.yaml 
  - http://www.getcloudify.org/spec/openstack-plugin/1.3.1/plugin.yaml 

inputs:
  # Openstack Inputs
  openstack_image_id:
    type: string
    default: 'ebab03e6-a674-4b6e-8f60-691c90fbcdc6' #centos7.2
  openstack_flavor_id:
    type: string
    default: '8e6069a3-d8c6-4741-8e0d-6373b2ca38cc' #dc1.1x1.20

  # General Inputs
  agent_user:
    type: string
    default: 'centos'

node_types:
  #here we define node_type for our apache application
  node_type_apache_runtime:
    derived_from: cloudify.openstack.nodes.Server
    interfaces:
#      cloudify.interfaces.lifecycle:
#        create: scripts/apache/install.sh
#        start: scripts/apache/start.sh
#        stop: scripts/apache/stop.sh
#        configure: scripts/apache/configure.sh
  
#what will be created
node_templates:
  vm_ip:
    type: cloudify.openstack.nodes.FloatingIP

  app_security_groups:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        description: Security group for DNS service with ssh
      rules:
        - port: 80
          remote_ip_prefix: 0.0.0.0/0
          protocol: tcp
        - port: 22
          remote_ip_prefix: 0.0.0.0/0
          protocol: tcp

  apache_template:
    type: node_type_apache_runtime
    properties:
      resource_id: apache_vm
      cloudify_agent:
        user: { get_input: agent_user }
      server:
        image: { get_input: openstack_image_id }
        flavor: { get_input: openstack_flavor_id }

    relationships:
      - type: cloudify.openstack.server_connected_to_floating_ip
        target: vm_ip
      - type: cloudify.openstack.server_connected_to_security_group
        target: app_security_groups


outputs:
  endpoint:
    description: Apache server IP/Port
    value:
      apache_ip: { get_attribute: [ vm_ip, floating_ip_address ] }
      apache_port: 80
